var app = angular.module('APP', ['ngRoute']);

app.config(function($routeProvider){

	$routeProvider

	.when('/', {
		templateUrl: 'views/list.html',
		controller: 'ListCtrl'
	})

	.when('/map', {
		templateUrl: 'views/map.html',
		controller: 'MapCtrl'
	})

	.otherwise({redirect: '/'});

});
app.factory('requestAjax', ['$http', '$q', function($http, $q){

	function RequestData() {
		var that = this;

		that.ObjResult = null;

		that.getList = function(url, id){
			var deferred = $q.defer();

			if (that.ObjResult !== null) {
				deferred.resolve(that.ObjResult);
			} else {
				var request = $http({
					url: url,
					method: 'GET',
					params: {
						resource_id: id
					}
				});

				request.success(function(response){
					that.ObjResult = response;
					deferred.resolve(response);
				});

				request.error(function(response) {
                   deferred.reject(response);
                });
			};

			return deferred.promise;
		}
	}

	return new RequestData();
}]);
app.controller('ListCtrl', ['$rootScope', '$location', 'requestAjax', '$scope', function($rootScope, $location, requestAjax, $scope){
	$rootScope.activeLink = $location.path();
	$scope.result = '';

	var url = 'http://dados.recife.pe.gov.br/api/action/datastore_search',
		id = '0d8fb090-2863-4d51-9b21-baae4bae5a11',
		getObj = requestAjax.getList(url, id);

	getObj.then(
		// success
		function(data){
			if (data.success == true) {
				$scope.result = data.result.records;
			}
		},

		// error
		function(error){
			console.log(error);
		}
	);
}]);
app.controller('MapCtrl', ['$rootScope', '$location', 'requestAjax', '$scope', function($rootScope, $location, requestAjax, $scope){
	$rootScope.activeLink = $location.path();
}]);
app.filter('search', function () {

	return function (arr, searchString) {

		if (!searchString) {
			return arr;
		}

		var result = [];

		searchString = searchString.toLowerCase();

		angular.forEach (arr, function (item) {

			if (item.nome.toLowerCase().indexOf(searchString) !== -1) {
				result.push(item);
			}
		});

		return result;
	};

});
app.directive('googleMap', ['requestAjax', function(requestAjax){
	return {
		restrict: 'E',
		template: '<div></div>',
		replace: true,
		link: function(scope, element, attrs){

			scope.makeMap = function(arr){
				var mapOptions = {
					center: new google.maps.LatLng(-8.087410, -34.884766),
					zoom: 12
				};
				var map = new google.maps.Map(document.getElementById(attrs.id),
					mapOptions);

				for (var i = 0; i < arr.length; i++) {
					var hotel = arr[i];

					var infowindow = new google.maps.InfoWindow();

					var marker = new google.maps.Marker({
					    position: new google.maps.LatLng(hotel.latitude, hotel.longitude),
					    map: map,
					    title: hotel.nome,
					    address: hotel.endereco,
					    site: hotel.site,
					    phone: hotel.telefone
					});

					google.maps.event.addListener(marker, 'click', (function(marker, i) {
					    return function() {
					    	infowindow.setContent(
					    		marker.site !== '' ?
						    		'<div class="info">' +
							    		'<h1>'           + marker.title   + '</h1>' +
							    		'<h2>Endereço: ' + marker.address + '</h2>' +
							    		'<h3>Telefone: ' + marker.phone   + '</h3>' +
							    		'<h4>Site: <a href="http://' + marker.site + '">'     + marker.site    + '</a></h4>' +
						    		'</div>'
					    		:
					    			'<div class="info">' +
							    		'<h1>'           + marker.title   + '</h1>' +
							    		'<h2>Endereço: ' + marker.address + '</h2>' +
							    		'<h3>Telefone: ' + marker.phone   + '</h3>' +
						    		'</div>'
					    		
					    	);
					        infowindow.open(map, marker);
					    }
					})(marker))
				};
			}

			var url = 'http://dados.recife.pe.gov.br/api/action/datastore_search',
				id = '0d8fb090-2863-4d51-9b21-baae4bae5a11',
				getObj = requestAjax.getList(url, id);

			getObj.then(
				// success
				function(data){
					if (data.success == true) {
						scope.makeMap(data.result.records);
					}
				},

				// error
				function(error){
					console.log(error);
				}
			);
			
		}
	}
}]);